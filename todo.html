<html>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>

  window.onload = function () {
    //redirect to login if session variable not set
    if (sessionStorage.getItem('loginName') === null) {
      window.location.replace('login.html')
    }
  }

  $(document).ready(populate);

  function populate() {
      update_list();
  }

  function update_list() {
    var loginName = sessionStorage.getItem('loginName');
    var url = 'api/tasks?mode=select&user=' + loginName;
    $.getJSON(url, function(data){
      $.each( data, function( key, val ) {
        addTaskToTable(val);
      });
    });
  }

  function finishTask (user, dateTime) {
    var loginName = sessionStorage.getItem('loginName');
    var requestUri = 'api/tasks?mode=delete&user=' + loginName + '&insertTime=' + dateTime;
    $.get(encodeURI(requestUri));

  }

  function addTaskToTable (val) {
    var table = document.getElementById('table1');
    var table_row = document.createElement('tr');

    var table_div1 = document.createElement('td');
    table_div1.appendChild(document.createTextNode(val['task']));
    table_row.appendChild(table_div1);

    var table_div2 = document.createElement('td');
    var finishButton = document.createElement('button');
    finishButton.onclick = function (){
      finishTask(sessionStorage.getItem('loginName'), val['insertTime']);
      this.parentNode.parentNode.remove();
    };
    finishButton.appendChild(document.createTextNode('Finish'));
    table_div2.appendChild(finishButton);
    table_row.appendChild(table_div2);

    table.appendChild(table_row);
  }

  function addTask (form) {
    var newTask = form.taskDescription.value;

    var dateTime = new Date().toISOString().slice(0,19).replace('T', ' ');

    var loginName = sessionStorage.getItem('loginName');

    var val = {
      user: loginName,
      insertTime: dateTime,
      task: newTask
    };
    addTaskToTable(val);

    var requestUri = 'api/tasks?mode=insert&user=' + loginName + '&insertTime=' +
        dateTime + '&task=' + newTask;

    $.get(encodeURI(requestUri));
  }

  function logout () {
    sessionStorage.removeItem('loginName');
    window.location.replace('login.html');
  }

  </script>
</head>
<body>
  <h1> Get Ready to WORK! </h1>
  <button type="button" onClick="logout()">Logout</button>
  <p> Here are the things you need to do: </p>
  <table id="table1">
    <tr>
        <td>Task</td> <td>Finish</td>
    </tr>
  </table>
  <br />
  <form name="createTaskForm">
    <input type="text" name="taskDescription" value="">
    <input type="button" name="submitTaskButton" value="Add" onClick="addTask(this.form)">
  </form>
</body>
</html>
